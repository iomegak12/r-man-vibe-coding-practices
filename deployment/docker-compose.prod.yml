# =====================================================
# R-MAN E-Commerce - Production Docker Compose
# Domain: r-man.work.gd
# Uses pre-built images (no build context)
# =====================================================

# =====================================================
# Networks
# =====================================================
networks:
  r-man-network:
    driver: bridge
    name: r-man-network

# =====================================================
# Volumes
# =====================================================
volumes:
  mongodb_data:
    driver: local
    name: rman-mongodb-data
  mongodb_config:
    driver: local
    name: rman-mongodb-config
  aths_uploads:
    driver: local
    name: rman-aths-uploads
  aths_logs:
    driver: local
    name: rman-aths-logs
  crms_logs:
    driver: local
    name: rman-crms-logs
  orms_logs:
    driver: local
    name: rman-orms-logs
  cmps_logs:
    driver: local
    name: rman-cmps-logs
  traefik_certs:
    driver: local
    name: rman-traefik-certs

services:
  # =====================================================
  # MongoDB Service (Shared Database)
  # =====================================================
  mongodb:
    image: mongo:7.0
    container_name: rman-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: auth_db
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - r-man-network

  # =====================================================
  # Mongo Express (MongoDB Admin UI)
  # =====================================================
  mongo-express:
    image: mongo-express:latest
    container_name: rman-mongo-express
    restart: unless-stopped
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: password123
      ME_CONFIG_MONGODB_URL: mongodb://admin:password123@mongodb:27017/
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin123
      ME_CONFIG_SITE_BASEURL: /
    ports:
      - "8081:8081"
    depends_on:
      - mongodb
    networks:
      - r-man-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mongo-express.rule=Host(`db.r-man.work.gd`)"
      - "traefik.http.routers.mongo-express.entrypoints=web,websecure"
      - "traefik.http.routers.mongo-express.tls=true"
      - "traefik.http.services.mongo-express.loadbalancer.server.port=8081"
      - "traefik.http.routers.mongo-express-insecure.rule=Host(`db.r-man.work.gd`)"
      - "traefik.http.routers.mongo-express-insecure.entrypoints=web"
      - "traefik.http.middlewares.mongo-express-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.mongo-express-insecure.middlewares=mongo-express-redirect"

  # =====================================================
  # ATHS - Authentication Service
  # =====================================================
  aths:
    image: rmanv1/aths:latest
    container_name: rman-aths
    restart: unless-stopped
    environment:
      # Server Configuration
      NODE_ENV: production
      PORT: 5001
      API_VERSION: v1

      # MongoDB Configuration
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/auth_db?authSource=admin
      MONGODB_TEST_URI: mongodb://admin:password123@mongodb:27017/auth_db_test?authSource=admin

      # JWT Configuration
      JWT_SECRET: 3c85c0cc01b287ebbb38d4fe0ae44fea
      JWT_ACCESS_TOKEN_EXPIRATION: 30m
      JWT_REFRESH_TOKEN_EXPIRATION: 7d

      # Bcrypt Configuration
      BCRYPT_SALT_ROUNDS: 12

      # Email Configuration (Gmail)
      EMAIL_SERVICE: gmail
      EMAIL_HOST: smtp.gmail.com
      EMAIL_PORT: 587
      EMAIL_SECURE: false
      EMAIL_USER: jd.ramkumar@gmail.com
      EMAIL_PASSWORD: laftvegmmgonuvmf
      EMAIL_FROM: noreply@rman-ecommerce.com
      EMAIL_FROM_NAME: R-MAN E-Commerce

      # Password Reset Configuration
      PASSWORD_RESET_TOKEN_EXPIRATION: 1h
      PASSWORD_RESET_URL: https://r-man.work.gd/reset-password

      # Email Verification Configuration
      EMAIL_VERIFICATION_URL: https://r-man.work.gd/verify-email

      # CORS Configuration
      CORS_ORIGIN: "*"
      CORS_CREDENTIALS: true

      # Rate Limiting
      RATE_LIMIT_ENABLED: false
      RATE_LIMIT_WINDOW_MS: 900000
      RATE_LIMIT_MAX_REQUESTS: 100

      # Service-to-Service Communication
      SERVICE_API_KEY: r-man-8vn6vR0XZm5OQYsES5vPLGHPD5tYCUHf

      # Logging
      LOG_LEVEL: info

      # Audit Logging
      AUDIT_LOG_RETENTION_DAYS: 90

      # CRMS Integration
      CRMS_BASE_URL: http://crms:5002
      CRMS_SERVICE_API_KEY: r-man-8vn6vR0XZm5OQYsES5vPLGHPD5tYCUHf
    ports:
      - "5001:5001"
    volumes:
      - aths_uploads:/app/uploads
      - aths_logs:/app/logs
    depends_on:
      - mongodb
    networks:
      - r-man-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.aths.rule=Host(`aths.r-man.work.gd`)"
      - "traefik.http.routers.aths.entrypoints=web,websecure"
      - "traefik.http.routers.aths.tls=true"
      - "traefik.http.services.aths.loadbalancer.server.port=5001"
      - "traefik.http.routers.aths-insecure.rule=Host(`aths.r-man.work.gd`)"
      - "traefik.http.routers.aths-insecure.entrypoints=web"
      - "traefik.http.middlewares.aths-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.aths-insecure.middlewares=aths-redirect"

  # =====================================================
  # CRMS - Customer Management Service
  # =====================================================
  crms:
    image: rmanv1/crms:latest
    container_name: rman-crms
    restart: unless-stopped
    environment:
      # Server Configuration
      ENVIRONMENT: production
      SERVICE_NAME: customer-service
      SERVICE_VERSION: 1.0.0
      PORT: 5002
      API_VERSION: v1

      # MongoDB Configuration
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/r-man-customers-db?authSource=admin
      MONGODB_MIN_POOL_SIZE: 10
      MONGODB_MAX_POOL_SIZE: 50

      # JWT Configuration (for token validation)
      JWT_SECRET: 3c85c0cc01b287ebbb38d4fe0ae44fea
      JWT_ALGORITHM: HS256

      # Service-to-Service Communication
      AUTH_SERVICE_URL: http://aths:5001
      ORDER_SERVICE_URL: http://orms:5003
      COMPLAINT_SERVICE_URL: http://cmps:5004
      SERVICE_API_KEY: r-man-8vn6vR0XZm5OQYsES5vPLGHPD5tYCUHf
      SERVICE_TIMEOUT: 30

      # CORS Configuration
      CORS_ORIGINS: '*'
      CORS_CREDENTIALS: true

      # Pagination
      DEFAULT_PAGE_SIZE: 20
      MAX_PAGE_SIZE: 100

      # Logging
      LOG_LEVEL: INFO
      LOG_FORMAT: json
    ports:
      - "5002:5002"
    volumes:
      - crms_logs:/app/logs
    depends_on:
      - mongodb
      - aths
    networks:
      - r-man-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.crms.rule=Host(`crms.r-man.work.gd`)"
      - "traefik.http.routers.crms.entrypoints=web,websecure"
      - "traefik.http.routers.crms.tls=true"
      - "traefik.http.services.crms.loadbalancer.server.port=5002"
      - "traefik.http.routers.crms-insecure.rule=Host(`crms.r-man.work.gd`)"
      - "traefik.http.routers.crms-insecure.entrypoints=web"
      - "traefik.http.middlewares.crms-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.crms-insecure.middlewares=crms-redirect"

  # =====================================================
  # ORMS - Order Management Service
  # =====================================================
  orms:
    image: rmanv1/orms:latest
    container_name: rman-orms
    restart: unless-stopped
    environment:
      # Server Configuration
      ENVIRONMENT: production
      SERVICE_NAME: order-service
      SERVICE_VERSION: 1.0.0
      PORT: 5003
      API_VERSION: v1

      # MongoDB Configuration
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/r-man-orders-db?authSource=admin
      MONGODB_MIN_POOL_SIZE: 10
      MONGODB_MAX_POOL_SIZE: 50

      # JWT Configuration (for token validation)
      JWT_SECRET: 3c85c0cc01b287ebbb38d4fe0ae44fea
      JWT_ALGORITHM: HS256

      # Service-to-Service Communication
      AUTH_SERVICE_URL: http://aths:5001
      CUSTOMER_SERVICE_URL: http://crms:5002
      SERVICE_API_KEY: r-man-8vn6vR0XZm5OQYsES5vPLGHPD5tYCUHf
      SERVICE_TIMEOUT: 30

      # CORS Configuration
      CORS_ORIGINS: '["*"]'
      CORS_CREDENTIALS: true

      # Pagination
      DEFAULT_PAGE_SIZE: 20
      MAX_PAGE_SIZE: 100

      # Order Configuration
      ORDER_ID_PREFIX: ORD
      RETURN_ID_PREFIX: RET
      ORDER_CANCELLATION_ALLOWED_STATUSES: '["Placed","Processing"]'
      ORDER_RETURN_ALLOWED_STATUSES: '["Delivered"]'

      # Logging
      LOG_LEVEL: INFO
      LOG_FORMAT: json
    ports:
      - "5003:5003"
    volumes:
      - orms_logs:/app/logs
    depends_on:
      - mongodb
      - aths
      - crms
    networks:
      - r-man-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.orms.rule=Host(`orms.r-man.work.gd`)"
      - "traefik.http.routers.orms.entrypoints=web,websecure"
      - "traefik.http.routers.orms.tls=true"
      - "traefik.http.services.orms.loadbalancer.server.port=5003"
      - "traefik.http.routers.orms-insecure.rule=Host(`orms.r-man.work.gd`)"
      - "traefik.http.routers.orms-insecure.entrypoints=web"
      - "traefik.http.middlewares.orms-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.orms-insecure.middlewares=orms-redirect"

  # =====================================================
  # CMPS - Complaint Management Service
  # =====================================================
  cmps:
    image: rmanv1/cmps:latest
    container_name: rman-cmps
    restart: unless-stopped
    environment:
      # Environment Configuration
      ENVIRONMENT: production

      # Service Configuration
      SERVICE_NAME: complaint-service
      PORT: 5004
      API_VERSION: v1

      # MongoDB Configuration
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/complaint_db?authSource=admin
      MONGODB_MIN_POOL_SIZE: 10
      MONGODB_MAX_POOL_SIZE: 50

      # JWT Configuration
      JWT_SECRET: 3c85c0cc01b287ebbb38d4fe0ae44fea
      JWT_ALGORITHM: HS256

      # Service URLs
      AUTH_SERVICE_URL: http://aths:5001
      CUSTOMER_SERVICE_URL: http://crms:5002
      ORDER_SERVICE_URL: http://orms:5003

      # Service API Key for internal communication
      SERVICE_API_KEY: r-man-8vn6vR0XZm5OQYsES5vPLGHPD5tYCUHf

      # Email Configuration
      EMAIL_SERVICE: gmail
      EMAIL_HOST: smtp.gmail.com
      EMAIL_PORT: 587
      EMAIL_SECURE: false
      EMAIL_USER: jd.ramkumar@gmail.com
      EMAIL_PASSWORD: laftvegmmgonuvmf
      EMAIL_FROM: noreply@rman-ecommerce.com
      EMAIL_FROM_NAME: R-MAN E-Commerce Support

      # Complaint Configuration
      COMPLAINT_ID_PREFIX: CMP

      # CORS Configuration
      CORS_ORIGINS: '[\"*\"]'

      # Logging
      LOG_LEVEL: INFO
    ports:
      - "5004:5004"
    volumes:
      - cmps_logs:/app/logs
    depends_on:
      - mongodb
      - aths
      - crms
      - orms
    networks:
      - r-man-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cmps.rule=Host(`cmps.r-man.work.gd`)"
      - "traefik.http.routers.cmps.entrypoints=web,websecure"
      - "traefik.http.routers.cmps.tls=true"
      - "traefik.http.services.cmps.loadbalancer.server.port=5004"
      - "traefik.http.routers.cmps-insecure.rule=Host(`cmps.r-man.work.gd`)"
      - "traefik.http.routers.cmps-insecure.entrypoints=web"
      - "traefik.http.middlewares.cmps-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.cmps-insecure.middlewares=cmps-redirect"

  # =====================================================
  # Web Application (React Frontend)
  # =====================================================
  web:
    image: rmanv1/web:latest
    container_name: rman-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - aths
      - crms
      - orms
      - cmps
    networks:
      - r-man-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`r-man.work.gd`) || Host(`www.r-man.work.gd`)"
      - "traefik.http.routers.web.entrypoints=web,websecure"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.services.web.loadbalancer.server.port=3000"
      - "traefik.http.routers.web-insecure.rule=Host(`r-man.work.gd`) || Host(`www.r-man.work.gd`)"
      - "traefik.http.routers.web-insecure.entrypoints=web"
      - "traefik.http.middlewares.web-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.web-insecure.middlewares=web-redirect"

  # =====================================================
  # Database Seeder (Runs once after all services start)
  # =====================================================
  seeder:
    image: rmanv1/seeder:latest
    container_name: rman-seeder
    restart: "no"
    environment:
      # MongoDB Configuration
      MONGODB_URI: mongodb://admin:password123@mongodb:27017/?authSource=admin
      
      # Database Names
      AUTH_DB_NAME: auth_db
      CUSTOMER_DB_NAME: r-man-customers-db
      ORDER_DB_NAME: r-man-orders-db
      COMPLAINT_DB_NAME: complaint_db
      
      # Seeding Configuration
      FORCE_SEEDING: false
      
      # Default Password
      DEFAULT_PASSWORD: Rman123!
      
      # Bcrypt Configuration
      BCRYPT_SALT_ROUNDS: 12
    command: >
      sh -c "
        echo '‚è≥ Waiting for all services to be ready...' &&
        sleep 30 &&
        echo 'üå± Starting database seeding...' &&
        npm run seed &&
        echo '‚úÖ Database seeding completed!'
      "
    depends_on:
      - mongodb
      - aths
      - crms
      - orms
      - cmps
    networks:
      - r-man-network

  # =====================================================
  # Traefik - Reverse Proxy & Load Balancer
  # =====================================================
  traefik:
    image: rmanv1/traefik:latest
    container_name: rman-traefik
    restart: unless-stopped
    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "8080:8080"   # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_certs:/etc/traefik/certs
    networks:
      - r-man-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.r-man.work.gd`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web,websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard-insecure.rule=Host(`traefik.r-man.work.gd`)"
      - "traefik.http.routers.dashboard-insecure.entrypoints=web"
      - "traefik.http.middlewares.dashboard-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.dashboard-insecure.middlewares=dashboard-redirect"
